<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vinsan Omni-Lab Simulator v2</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #121212; color: #e0e0e0; }
        
        /* Main Container */
        #canvas-container { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }

        /* Floating UI Panel */
        #ui-panel {
            position: absolute; top: 20px; left: 20px; z-index: 10;
            background: rgba(30, 30, 30, 0.95); 
            padding: 20px; border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            width: 280px; border: 1px solid #333;
        }

        h3 { margin: 0 0 15px 0; font-size: 18px; color: #4caf50; border-bottom: 2px solid #4caf50; padding-bottom: 8px; }

        /* Buttons & Inputs */
        .btn {
            display: block; width: 100%; padding: 12px; margin-bottom: 10px;
            background: #2c2c2c; border: 1px solid #444; border-radius: 6px;
            color: white; cursor: pointer; text-align: left; transition: all 0.2s;
            font-size: 14px;
        }
        .btn:hover { background: #3a3a3a; border-color: #4caf50; }
        .btn.active { background: #1b5e20; border-color: #4caf50; }

        /* Board Selection Modal (Hidden by default) */
        #board-market {
            display: none; position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); z-index: 20;
            background: #1e1e1e; padding: 25px; border-radius: 15px;
            width: 500px; box-shadow: 0 0 50px rgba(0,0,0,0.8);
            border: 1px solid #444;
        }
        #board-market h2 { margin-top: 0; color: #4caf50; }
        .board-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-height: 400px; overflow-y: auto; }
        .market-item {
            background: #252525; padding: 15px; border-radius: 8px; border: 1px solid #333;
            cursor: pointer; transition: 0.2s;
        }
        .market-item:hover { background: #333; border-color: #4caf50; }
        .market-item h4 { margin: 0 0 5px 0; color: white; }
        .market-item p { margin: 0; font-size: 12px; color: #aaa; }
        .close-btn { 
            position: absolute; top: 15px; right: 15px; background: none; border: none; 
            color: #aaa; font-size: 20px; cursor: pointer; width: auto; 
        }

        /* Color Picker for Wires */
        .color-picker { display: flex; gap: 5px; margin-bottom: 10px; }
        .color-opt { width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .color-opt.selected { border-color: white; transform: scale(1.1); }

        /* Status Bar */
        #status-bar {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: #4caf50; padding: 10px 30px;
            border-radius: 30px; font-weight: bold; border: 1px solid #333; z-index: 10;
        }
    </style>
</head>
<body>

    <div id="ui-panel">
        <h3>Omni-Lab Tools</h3>
        
        <button id="btn-open-market" class="btn">ðŸ›’ Add Board / MCU</button>
        <button id="btn-add-breadboard" class="btn">â–¦ Add Breadboard</button>
        <button id="btn-add-led" class="btn">ðŸ’¡ Add LED</button>
        
        <div style="margin: 15px 0; border-top: 1px solid #444; padding-top: 15px;">
            <label style="font-size: 12px; color: #888;">Wire Color:</label>
            <div class="color-picker" id="wire-colors">
                <div class="color-opt selected" style="background: #ff0000;" data-hex="0xff0000"></div> <div class="color-opt" style="background: #000000;" data-hex="0x000000"></div> <div class="color-opt" style="background: #00ff00;" data-hex="0x00ff00"></div> <div class="color-opt" style="background: #0000ff;" data-hex="0x0000ff"></div> <div class="color-opt" style="background: #ffff00;" data-hex="0xffff00"></div> </div>
        </div>

        <button id="mode-select" class="btn active">ðŸ‘† Select / Drag</button>
        <button id="mode-wire" class="btn">ðŸ”Œ Wire Mode</button>
        
        <div style="font-size: 11px; color: #666; margin-top: 10px;">
            Left Click: Select/Place<br>
            Right Click (Drag): Rotate Cam<br>
            Scroll: Zoom
        </div>
    </div>

    <div id="board-market">
        <button class="close-btn" id="close-market">&times;</button>
        <h2>Component Market</h2>
        <div class="board-grid">
            <div class="market-item" onclick="startPlacement('uno')">
                <h4>Arduino Uno</h4>
                <p>Standard ATmega328P board.</p>
            </div>
            <div class="market-item" onclick="startPlacement('mega')">
                <h4>Arduino Mega</h4>
                <p>Larger board, more I/O pins.</p>
            </div>
            <div class="market-item" onclick="startPlacement('esp32')">
                <h4>ESP-32 Dev Module</h4>
                <p>Wi-Fi + Bluetooth enabled.</p>
            </div>
            <div class="market-item" onclick="startPlacement('nano')">
                <h4>Arduino Nano</h4>
                <p>Compact breadboard-friendly.</p>
            </div>
            <div class="market-item" onclick="startPlacement('rpi')">
                <h4>Raspberry Pi 4</h4>
                <p>Single Board Computer (Green).</p>
            </div>
        </div>
    </div>

    <div id="status-bar">Ready</div>
    <div id="canvas-container"></div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- GLOBAL STATE ---
        const state = {
            mode: 'SELECT', // SELECT, WIRE, PLACING
            placingType: null, // What are we placing?
            wireColor: 0xff0000,
            selectedPin: null,
            ghostMesh: null // The transparent mesh following mouse
        };

        const components = [];
        const wires = [];

        // --- BOARD DEFINITIONS (The "Market" Data) ---
        const BOARD_SPECS = {
            'uno': { name: 'Arduino Uno', w: 3, h: 0.3, d: 2, color: 0x0088aa, pins: [{x:1.2, z:-0.8, type:'pwr'}, {x:1.2, z:0.8, type:'gnd'}] },
            'mega': { name: 'Arduino Mega', w: 5, h: 0.3, d: 2, color: 0x006688, pins: [{x:2, z:-0.8, type:'pwr'}, {x:2, z:0.8, type:'gnd'}] },
            'nano': { name: 'Arduino Nano', w: 1, h: 0.2, d: 3, color: 0x0088aa, pins: [{x:0.3, z:-1.2, type:'pwr'}, {x:0.3, z:1.2, type:'gnd'}] },
            'esp32': { name: 'ESP32 DevKit', w: 1.5, h: 0.2, d: 2.5, color: 0x111111, pins: [{x:0.5, z:-1, type:'pwr'}, {x:0.5, z:1, type:'gnd'}] },
            'rpi': { name: 'Raspberry Pi', w: 3.5, h: 0.2, d: 2.2, color: 0x27ae60, pins: [{x:1.5, z:-0.9, type:'pwr'}, {x:1.5, z:0.9, type:'gnd'}] }
        };

        // --- SCENE SETUP ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a1a);
        
        // Grid Floor
        const gridHelper = new THREE.GridHelper(30, 30, 0x444444, 0x222222);
        scene.add(gridHelper);
        const planeGeo = new THREE.PlaneGeometry(30, 30);
        const planeMat = new THREE.MeshBasicMaterial({ visible: false }); // Invisible plane for raycasting placement
        const groundPlane = new THREE.Mesh(planeGeo, planeMat);
        groundPlane.rotation.x = -Math.PI / 2;
        scene.add(groundPlane);

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(8, 12, 8);
        
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        container.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        // Lights
        scene.add(new THREE.AmbientLight(0xffffff, 0.7));
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(10, 20, 10);
        dirLight.castShadow = true;
        scene.add(dirLight);

        // --- COMPONENT CLASSES ---

        class Component {
            constructor(name) {
                this.name = name;
                this.mesh = new THREE.Group();
                this.pins = [];
            }
            
            addToScene(pos) {
                this.mesh.position.copy(pos);
                scene.add(this.mesh);
                components.push(this);
            }

            addPin(lx, ly, lz, type, id) {
                const geo = new THREE.BoxGeometry(0.15, 0.15, 0.15);
                const color = type === 'pwr' ? 0xff3333 : (type === 'gnd' ? 0x3333ff : 0xdddddd);
                const mat = new THREE.MeshStandardMaterial({ color: color });
                const pin = new THREE.Mesh(geo, mat);
                pin.position.set(lx, ly, lz);
                pin.userData = { isPin: true, parent: this, type: type, id: id };
                this.mesh.add(pin);
                this.pins.push(pin);
            }
        }

        // Factory function for Boards
        function createBoard(typeStr) {
            const spec = BOARD_SPECS[typeStr];
            const comp = new Component(spec.name);
            
            // PCB Mesh
            const pcb = new THREE.Mesh(
                new THREE.BoxGeometry(spec.w, spec.h, spec.d),
                new THREE.MeshStandardMaterial({ color: spec.color, roughness: 0.6 })
            );
            pcb.castShadow = true;
            comp.mesh.add(pcb);
            
            // Add Pins from Spec
            spec.pins.forEach((p, i) => comp.addPin(p.x, spec.h/2 + 0.1, p.z, p.type, `Pin${i}`));

            // Label
            // (Simulated text label logic would go here, simplified for this prototype)

            return comp;
        }

        function createBreadboard() {
            const comp = new Component("Breadboard");
            const base = new THREE.Mesh(
                new THREE.BoxGeometry(4, 0.3, 5),
                new THREE.MeshStandardMaterial({ color: 0xf0f0f0 })
            );
            comp.mesh.add(base);
            
            // Add grid of holes (simplified pins)
            for(let x=-1.5; x<=1.5; x+=0.5) {
                for(let z=-2; z<=2; z+=0.5) {
                    comp.addPin(x, 0.2, z, 'node', `r${x}c${z}`);
                }
            }
            return comp;
        }

        function createLED() {
            const comp = new Component("LED");
            
            // Legs
            const legMat = new THREE.MeshStandardMaterial({ color: 0xaaaaaa });
            const leg1 = new THREE.Mesh(new THREE.CylinderGeometry(0.03, 0.03, 0.6), legMat);
            leg1.position.set(-0.1, 0.3, 0);
            const leg2 = new THREE.Mesh(new THREE.CylinderGeometry(0.03, 0.03, 0.6), legMat);
            leg2.position.set(0.1, 0.3, 0);
            comp.mesh.add(leg1); comp.mesh.add(leg2);

            // Bulb
            const bulb = new THREE.Mesh(
                new THREE.SphereGeometry(0.3),
                new THREE.MeshStandardMaterial({ color: 0xff0000, transparent: true, opacity: 0.9 })
            );
            bulb.position.set(0, 0.7, 0);
            comp.mesh.add(bulb);

            comp.addPin(-0.1, 0, 0, 'node', 'Anode');
            comp.addPin(0.1, 0, 0, 'node', 'Cathode');
            
            return comp;
        }


        // --- INTERACTION LOGIC ---

        // Raycasting setup
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        function getRayIntersection(e, objects) {
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            return raycaster.intersectObjects(objects, true);
        }

        window.addEventListener('mousemove', (e) => {
            // Placement Logic (Ghost follows mouse)
            if (state.mode === 'PLACING' && state.ghostMesh) {
                const hits = getRayIntersection(e, [groundPlane]);
                if (hits.length > 0) {
                    const pos = hits[0].point;
                    // Snap to grid (0.5 units)
                    pos.x = Math.round(pos.x * 2) / 2;
                    pos.z = Math.round(pos.z * 2) / 2;
                    pos.y = 0.2; // slight offset
                    state.ghostMesh.position.copy(pos);
                }
            }
        });

        window.addEventListener('click', (e) => {
            if (e.target.closest('#ui-panel') || e.target.closest('#board-market')) return; // Ignore UI clicks

            if (state.mode === 'PLACING') {
                finalizePlacement();
                return;
            }

            // Normal Interaction (Wire/Select)
            const allPins = [];
            components.forEach(c => allPins.push(...c.pins));
            const hits = getRayIntersection(e, allPins);

            if (hits.length > 0) {
                const pin = hits[0].object;
                handlePinClick(pin);
            }
        });

        // --- CORE FUNCTIONS ---

        // 1. Placement System
        window.startPlacement = function(type) {
            state.mode = 'PLACING';
            state.placingType = type;
            
            // Close modal
            document.getElementById('board-market').style.display = 'none';
            document.getElementById('status-bar').innerText = "Placement Mode: Click grid to place.";

            // Create Ghost
            if (state.ghostMesh) scene.remove(state.ghostMesh);
            
            let tempComp;
            if (type === 'breadboard') tempComp = createBreadboard();
            else if (type === 'led') tempComp = createLED();
            else tempComp = createBoard(type); // It's a board

            state.ghostMesh = tempComp.mesh.clone();
            
            // Make ghost transparent
            state.ghostMesh.traverse((child) => {
                if (child.isMesh) {
                    child.material = child.material.clone();
                    child.material.transparent = true;
                    child.material.opacity = 0.5;
                }
            });
            scene.add(state.ghostMesh);
        };

        function finalizePlacement() {
            if (!state.ghostMesh) return;
            
            const pos = state.ghostMesh.position.clone();
            scene.remove(state.ghostMesh);
            state.ghostMesh = null;

            // Instantiate real component
            let realComp;
            if (state.placingType === 'breadboard') realComp = createBreadboard();
            else if (state.placingType === 'led') realComp = createLED();
            else realComp = createBoard(state.placingType);

            realComp.addToScene(pos);
            
            state.mode = 'SELECT';
            state.placingType = null;
            document.getElementById('status-bar').innerText = "Ready.";
            highlightButton('mode-select');
        }

        // 2. Wiring System
        function handlePinClick(pin) {
            if (state.mode !== 'WIRE') return;

            if (!state.selectedPin) {
                // Select first pin
                state.selectedPin = pin;
                pin.material.emissive.setHex(0xffff00); // Glow
                document.getElementById('status-bar').innerText = "Wire Start Selected. Click Target Pin.";
            } else {
                // Connect
                if (state.selectedPin === pin) return; // Can't wire to self
                createWire(state.selectedPin, pin, state.wireColor);
                
                // Reset
                state.selectedPin.material.emissive.setHex(0x000000);
                state.selectedPin = null;
                document.getElementById('status-bar').innerText = "Wire Connected!";
            }
        }

        function createWire(pinA, pinB, colorHex) {
            const start = new THREE.Vector3();
            const end = new THREE.Vector3();
            pinA.getWorldPosition(start);
            pinB.getWorldPosition(end);

            // Curve
            const height = start.distanceTo(end) * 0.5 + 0.5;
            const mid = new THREE.Vector3().addVectors(start, end).multiplyScalar(0.5);
            mid.y += height;

            const curve = new THREE.QuadraticBezierCurve3(start, mid, end);
            const tubeGeo = new THREE.TubeGeometry(curve, 20, 0.05, 8, false);
            const mat = new THREE.MeshStandardMaterial({ color: colorHex });
            const wireMesh = new THREE.Mesh(tubeGeo, mat);
            
            scene.add(wireMesh);
            wires.push({ mesh: wireMesh, p1: pinA, p2: pinB });
        }


        // --- UI BINDINGS ---
        document.getElementById('btn-open-market').onclick = () => {
            document.getElementById('board-market').style.display = 'block';
        };
        document.getElementById('close-market').onclick = () => {
            document.getElementById('board-market').style.display = 'none';
        };
        document.getElementById('btn-add-breadboard').onclick = () => startPlacement('breadboard');
        document.getElementById('btn-add-led').onclick = () => startPlacement('led');

        document.getElementById('mode-wire').onclick = () => {
            state.mode = 'WIRE';
            highlightButton('mode-wire');
            document.getElementById('status-bar').innerText = "Mode: WIRE. Select wire color and connect pins.";
        };
        document.getElementById('mode-select').onclick = () => {
            state.mode = 'SELECT';
            if (state.selectedPin) state.selectedPin.material.emissive.setHex(0x000000);
            state.selectedPin = null;
            highlightButton('mode-select');
            document.getElementById('status-bar').innerText = "Mode: SELECT/DRAG.";
        };

        // Color Picker
        document.querySelectorAll('.color-opt').forEach(el => {
            el.addEventListener('click', (e) => {
                document.querySelectorAll('.color-opt').forEach(x => x.classList.remove('selected'));
                e.target.classList.add('selected');
                state.wireColor = parseInt(e.target.dataset.hex);
            });
        });

        function highlightButton(id) {
            document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- ANIMATION ---
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        // Handle resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>
