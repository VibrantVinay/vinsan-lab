<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vinsan Omni-Lab Pro v7.0 (Professional Edition)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #121212;
            --bg-panel: #1e1e1e;
            --bg-header: #252525;
            --accent: #007acc;
            --accent-hover: #0098ff;
            --text-main: #e0e0e0;
            --text-dim: #a0a0a0;
            --border: #333;
            --success: #4caf50;
            --danger: #f44336;
            --warning: #ff9800;
        }

        body { margin: 0; overflow: hidden; font-family: 'Inter', sans-serif; background: var(--bg-dark); color: var(--text-main); user-select: none; }
        
        /* LAYOUT GRID */
        #app-container {
            display: grid;
            grid-template-rows: 50px 1fr 30px;
            grid-template-columns: 260px 1fr 320px; /* Widened right panel for Scope */
            height: 100vh; width: 100vw;
        }

        /* 1. TOP HEADER */
        header {
            grid-column: 1 / -1;
            background: var(--bg-header);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; padding: 0 20px;
            justify-content: space-between;
            z-index: 10;
        }
        .brand { font-family: 'JetBrains Mono', monospace; font-weight: 700; color: var(--accent); font-size: 18px; letter-spacing: 1px; display:flex; align-items:center; gap:10px; }
        .toolbar-center { display: flex; gap: 10px; background: #1a1a1a; padding: 4px; border-radius: 6px; border: 1px solid var(--border); }
        .tool-btn {
            background: transparent; border: none; color: var(--text-dim);
            padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600;
            transition: 0.2s; display: flex; align-items: center; gap: 6px;
        }
        .tool-btn:hover { background: #333; color: white; }
        .tool-btn.active { background: var(--accent); color: white; }
        
        .action-group { display: flex; gap: 8px; margin-right: 20px; }
        .icon-btn { background: #333; border: 1px solid var(--border); color: #ccc; width: 32px; height: 32px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .icon-btn:hover { background: #444; color: white; }

        .sim-controls { display: flex; gap: 10px; }
        .sim-btn {
            background: var(--success); color: white; border: none; padding: 6px 16px; 
            border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 12px;
            display: flex; align-items: center; gap: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .sim-btn:hover { filter: brightness(1.1); }
        .sim-btn.stop { background: var(--danger); display: none; }

        /* 2. LEFT SIDEBAR */
        #library-panel {
            grid-row: 2; grid-column: 1;
            background: var(--bg-panel); border-right: 1px solid var(--border);
            overflow-y: auto; padding: 0; display: flex; flex-direction: column;
        }
        .panel-header {
            padding: 15px; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; 
            color: var(--text-dim); font-weight: bold; border-bottom: 1px solid var(--border);
            background: #222; position: sticky; top: 0;
        }
        .category-title {
            padding: 12px 15px; font-size: 13px; font-weight: 600; cursor: pointer;
            background: #2a2a2a; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; color: #ccc;
        }
        .category-title:hover { background: #333; color: white; }
        .category-content { display: grid; gap: 8px; padding: 10px; }
        .part-card {
            background: #333; padding: 8px; border-radius: 4px; cursor: pointer;
            border: 1px solid transparent; transition: 0.2s; display: flex; align-items: center; gap: 10px;
        }
        .part-card:hover { border-color: var(--accent); background: #3a3a3a; transform: translateX(2px); }
        .part-icon { width: 32px; height: 32px; background: #222; border-radius: 3px; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .part-info h4 { margin: 0; font-size: 13px; color: white; }
        .part-info p { margin: 2px 0 0; font-size: 10px; color: #aaa; }

        /* 3. CENTER (Canvas) */
        #canvas-wrapper {
            grid-row: 2; grid-column: 2;
            position: relative; overflow: hidden; background: #101010;
        }
        #canvas-container { width: 100%; height: 100%; outline: none; }

        /* 4. RIGHT SIDEBAR (Multi-Tab Professional Tools) */
        #properties-panel {
            grid-row: 2; grid-column: 3;
            background: var(--bg-panel); border-left: 1px solid var(--border);
            display: flex; flex-direction: column; overflow: hidden;
        }
        
        /* TABS */
        .sidebar-tabs { display: flex; border-bottom: 1px solid var(--border); background: #222; }
        .sidebar-tab { 
            flex: 1; text-align: center; padding: 10px 0; cursor: pointer; font-size: 11px; 
            color: var(--text-dim); font-weight: 600; border-bottom: 2px solid transparent; 
        }
        .sidebar-tab:hover { color: white; background: #2a2a2a; }
        .sidebar-tab.active { color: var(--accent); border-bottom-color: var(--accent); background: #1e1e1e; }

        /* TAB CONTENT AREAS */
        .tab-content { display: none; flex: 1; flex-direction: column; overflow: hidden; }
        .tab-content.active { display: flex; }

        /* PROPERTIES */
        #prop-content { padding: 20px; overflow-y: auto; }
        .prop-group { margin-bottom: 20px; }
        .prop-label { display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 5px; }
        .prop-value { 
            width: 100%; background: #111; border: 1px solid var(--border); color: white;
            padding: 8px; border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 12px; box-sizing: border-box;
        }
        .color-palette { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 5px; }
        .color-swatch { 
            width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid transparent;
            transition: transform 0.2s; 
        }
        .color-swatch.active { border-color: white; transform: scale(1.1); box-shadow: 0 0 8px rgba(255,255,255,0.2); }

        /* SERIAL MONITOR */
        #serial-output {
            flex: 1; padding: 10px; font-family: 'JetBrains Mono', monospace; font-size: 12px;
            color: #4caf50; overflow-y: auto; white-space: pre-wrap; word-break: break-all; background: #111;
        }

        /* OSCILLOSCOPE */
        #scope-canvas { background: #000; width: 100%; height: 200px; border-bottom: 1px solid #333; }
        .scope-controls { padding: 10px; background: #151515; }

        /* BOM (Bill of Materials) */
        #bom-list { padding: 0; margin: 0; list-style: none; overflow-y: auto; }
        .bom-item { 
            padding: 10px 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; font-size: 12px;
        }
        .bom-item span:first-child { font-weight: bold; color: white; }
        .bom-btn { width: 100%; padding: 10px; background: #333; border: none; color: white; cursor: pointer; text-align: center; font-size: 12px; }
        .bom-btn:hover { background: #444; }

        /* CODE EDITOR (Overlay) */
        #code-editor {
            position: absolute; bottom: 0; left: 0; right: 0;
            height: 0; background: #1e1e1e; border-top: 1px solid var(--border);
            transition: height 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex; flex-direction: column; overflow: hidden;
            z-index: 20;
        }
        #code-editor.open { height: 350px; }
        .editor-header {
            background: #252525; padding: 0 15px; height: 35px; display: flex; align-items: center; justify-content: space-between;
            font-size: 12px; border-bottom: 1px solid #333;
        }
        .editor-tabs { display: flex; gap: 2px; height: 100%; }
        .tab { background: #1e1e1e; padding: 0 15px; display: flex; align-items: center; border-top: 2px solid var(--accent); color: white; cursor: pointer; font-family: 'Inter'; }
        .editor-area {
            flex: 1; background: #151515; color: #d4d4d4; border: none; padding: 15px;
            font-family: 'JetBrains Mono', monospace; font-size: 13px; line-height: 1.5; resize: none; outline: none;
        }

        /* 5. STATUS BAR */
        footer {
            grid-row: 3; grid-column: 1 / -1;
            background: var(--accent); color: white;
            display: flex; align-items: center; padding: 0 15px; font-size: 12px; font-weight: 500;
            justify-content: space-between; z-index: 30;
        }
        .coords { font-family: 'JetBrains Mono', monospace; opacity: 0.8; }

        /* OVERLAYS & TOASTS */
        #controls-hint {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); padding: 8px 16px; border-radius: 20px;
            font-size: 12px; pointer-events: none; opacity: 0; transition: opacity 0.3s;
            border: 1px solid #444; color: white;
        }
        #controls-hint.visible { opacity: 1; }

        #modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 100;
        }
        .modal {
            background: #1e1e1e; padding: 25px; border-radius: 8px; border: 1px solid #444;
            width: 400px; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .modal h2 { margin-top: 0; color: var(--accent); }
        .modal ul { line-height: 1.6; font-size: 14px; padding-left: 20px; color: #ccc; }
        .btn-modal { background: var(--accent); border: none; color: white; padding: 8px 16px; border-radius: 4px; cursor: pointer; float: right; }
        
        /* SCROLLBARS */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body>

<div id="app-container">
    <header>
        <div class="brand">
            <span style="font-size:20px;">‚ö°</span>
            <div>VINSAN LAB <span style="font-size:10px; color:#888; font-weight:400; display:block; line-height:1;">PRO v7.0</span></div>
        </div>
        
        <div class="toolbar-center">
            <button class="tool-btn active" id="tool-select" onclick="setMode('SELECT')" title="Select Tool (V)">
                <span>‚Üñ</span> Select
            </button>
            <button class="tool-btn" id="tool-wire" onclick="setMode('WIRE')" title="Wire Tool (W)">
                <span>‚àø</span> Wire
            </button>
            <button class="tool-btn" id="tool-delete" onclick="deleteSelected()" title="Delete Selected (Del)">
                <span>üóë</span> Delete
            </button>
        </div>

        <div style="display:flex; align-items:center;">
            <div class="action-group">
                <button class="icon-btn" onclick="toggleCode()" title="Toggle Code Editor (C)"><span>{ }</span></button>
                <button class="icon-btn" onclick="saveCircuit()" title="Save Circuit"><span>üíæ</span></button>
                <button class="icon-btn" onclick="document.getElementById('file-input').click()" title="Load Circuit"><span>üìÇ</span></button>
                <button class="icon-btn" onclick="clearBoard()" title="Clear Board"><span>‚úï</span></button>
                <button class="icon-btn" onclick="toggleHelp()" title="Help"><span>?</span></button>
                <input type="file" id="file-input" style="display:none" onchange="loadCircuit(this)">
            </div>

            <div class="sim-controls">
                <button class="sim-btn" id="btn-run" onclick="toggleSim()">‚ñ∂ Start Simulation</button>
                <button class="sim-btn stop" id="btn-stop" onclick="toggleSim()">‚ñ† Stop Simulation</button>
            </div>
        </div>
    </header>

    <div id="library-panel">
        <div class="panel-header">Component Library</div>
        
        <div class="category-title" onclick="toggleCat(this)">MICROCONTROLLERS <span>‚ñº</span></div>
        <div class="category-content">
            <div class="part-card" onclick="startPlacement('uno')">
                <div class="part-icon" style="color:#0088aa; border: 1px solid #0088aa;">U</div>
                <div class="part-info"><h4>Arduino Uno</h4><p>ATmega328P</p></div>
            </div>
            <div class="part-card" onclick="startPlacement('mega')">
                <div class="part-icon" style="color:#006688; border: 1px solid #006688;">M</div>
                <div class="part-info"><h4>Arduino Mega</h4><p>ATmega2560</p></div>
            </div>
            <div class="part-card" onclick="startPlacement('esp32')">
                <div class="part-icon" style="color:#888; border:1px solid #555;">E</div>
                <div class="part-info"><h4>ESP-32</h4><p>WiFi / BT Module</p></div>
            </div>
        </div>

        <div class="category-title" onclick="toggleCat(this)">ACTUATORS <span>‚ñº</span></div>
        <div class="category-content">
             <div class="part-card" onclick="startPlacement('led')">
                <div class="part-icon" style="color:#f44336;">üí°</div>
                <div class="part-info"><h4>LED (Red)</h4><p>Light Emitting Diode</p></div>
            </div>
             <div class="part-card" onclick="startPlacement('servo')">
                <div class="part-icon" style="color:#e6c99c;">‚îå‚îÄ‚îê</div>
                <div class="part-info"><h4>Servo Motor</h4><p>Standard Servo</p></div>
            </div>
        </div>

        <div class="category-title" onclick="toggleCat(this)">SENSORS / INPUT <span>‚ñº</span></div>
        <div class="category-content">
            <div class="part-card" onclick="startPlacement('pushbutton')">
                <div class="part-icon" style="color:#555;">‚ö´</div>
                <div class="part-info"><h4>Push Button</h4><p>Tactile Switch</p></div>
            </div>
            <div class="part-card" onclick="startPlacement('potentiometer')">
                <div class="part-icon" style="color:#333;">‚óé</div>
                <div class="part-info"><h4>Potentiometer</h4><p>10k Ohm Variable</p></div>
            </div>
        </div>
        
        <div class="category-title" onclick="toggleCat(this)">INFRASTRUCTURE <span>‚ñº</span></div>
        <div class="category-content">
            <div class="part-card" onclick="startPlacement('breadboard')">
                <div class="part-icon" style="color:#eee; background:#333;">‚ñ¶</div>
                <div class="part-info"><h4>Breadboard</h4><p>830 Tie-Points</p></div>
            </div>
             <div class="part-card" onclick="startPlacement('resistor')">
                <div class="part-icon" style="color:#e6c99c;">„Ä∞</div>
                <div class="part-info"><h4>Resistor</h4><p>1k Ohm</p></div>
            </div>
        </div>
    </div>

    <div id="canvas-wrapper">
        <div id="canvas-container"></div>
        <div id="controls-hint"><b>R</b> to Rotate ‚Ä¢ <b>Esc</b> to Cancel ‚Ä¢ <b>Click</b> to Place</div>
        
        <div id="code-editor">
            <div class="editor-header">
                <div class="editor-tabs">
                    <div class="tab">sketch.ino</div>
                </div>
                <div style="cursor:pointer" onclick="toggleCode()">‚ñº Hide Editor</div>
            </div>
            <textarea class="editor-area" id="editor-text" spellcheck="false">
// Vinsan Omni-Lab v7.0
// Professional Simulation Engine

int led = 13;
int potPin = A0;

void setup() {
  pinMode(led, OUTPUT);
  Serial.begin(9600);
  Serial.println("System Initialized");
}

void loop() {
  // Read Potentiometer (Simulated)
  int val = analogRead(potPin); 
  
  // Plot to Oscilloscope
  Scope.plot(val);
  
  Serial.print("Analog: ");
  Serial.println(val);
  
  if (val > 512) {
    digitalWrite(led, HIGH);
  } else {
    digitalWrite(led, LOW);
  }
  
  delay(100);
}
</textarea>
        </div>
    </div>

    <div id="properties-panel">
        <div class="sidebar-tabs">
            <div class="sidebar-tab active" onclick="switchTab('props')">PROPERTIES</div>
            <div class="sidebar-tab" onclick="switchTab('serial')">SERIAL</div>
            <div class="sidebar-tab" onclick="switchTab('scope')">SCOPE</div>
            <div class="sidebar-tab" onclick="switchTab('bom')">BOM</div>
        </div>

        <div id="tab-props" class="tab-content active">
            <div id="prop-content">
                <div id="prop-empty" style="text-align: center; color: #666; margin-top: 50px;">
                    Select a component.
                </div>
                <div id="prop-fields" style="display: none;">
                    <div class="prop-group">
                        <label class="prop-label">Name</label>
                        <input type="text" class="prop-value" id="prop-name" oninput="updateName(this.value)">
                    </div>
                    <div class="prop-group">
                        <label class="prop-label">Type</label>
                        <div class="prop-value" id="prop-type" style="border:none; padding:0; color:var(--accent);"></div>
                    </div>
                    <div class="prop-group" id="prop-extra" style="display:none;">
                         <label class="prop-label">Potentiometer Value (0-100%)</label>
                         <input type="range" class="prop-value" id="prop-slider" min="0" max="100" oninput="updatePot(this.value)">
                    </div>
                </div>

                <div class="panel-header" style="margin: 20px -20px 10px -20px; padding: 10px 15px;">Wire Color</div>
                <div class="color-palette" id="wire-palette">
                    <div class="color-swatch active" style="background:#f44336;" onclick="setWireColor(0xf44336, this)"></div>
                    <div class="color-swatch" style="background:#111; border-color:#555;" onclick="setWireColor(0x111111, this)"></div>
                    <div class="color-swatch" style="background:#4caf50;" onclick="setWireColor(0x4caf50, this)"></div>
                    <div class="color-swatch" style="background:#2196f3;" onclick="setWireColor(0x2196f3, this)"></div>
                    <div class="color-swatch" style="background:#ffeb3b;" onclick="setWireColor(0xffeb3b, this)"></div>
                </div>
            </div>
        </div>

        <div id="tab-serial" class="tab-content">
            <div id="serial-output"></div>
            <div style="padding:10px; border-top:1px solid #333; display:flex; gap:5px;">
                 <input type="text" class="prop-value" placeholder="Send Data...">
                 <button class="icon-btn" style="width:auto; padding:0 10px;">Send</button>
            </div>
        </div>

        <div id="tab-scope" class="tab-content">
            <canvas id="scope-canvas" width="300" height="200"></canvas>
            <div class="scope-controls">
                <div class="prop-label">Use <code>Scope.plot(val)</code> in code</div>
                <div style="font-size:10px; color:#666;">Time Base: 100ms/div</div>
            </div>
        </div>

        <div id="tab-bom" class="tab-content">
            <ul id="bom-list"></ul>
            <div style="padding:15px;">
                <button class="bom-btn" onclick="exportBOM()">Download CSV</button>
            </div>
        </div>
    </div>

    <footer>
        <div id="status-msg">System Ready</div>
        <div class="coords" id="mouse-coords">X: 0.0 Z: 0.0</div>
    </footer>
</div>

<div id="modal-overlay">
    <div class="modal">
        <h2>Professional Features</h2>
        <ul>
            <li><b>Oscilloscope:</b> Use <code>Scope.plot(val)</code> to visualize analog data.</li>
            <li><b>BOM Manager:</b> Export parts list to CSV.</li>
            <li><b>Potentiometer:</b> Adjustable analog input (use Slider in Properties).</li>
            <li><b>Shortcuts:</b> <b>R</b> Rotate, <b>Del</b> Delete, <b>Esc</b> Cancel.</li>
        </ul>
        <button class="btn-modal" onclick="toggleHelp()">Close</button>
    </div>
</div>

<script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
</script>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    // --- CONFIG & STATE ---
    const config = { gridSize: 60, snap: 0.5 };
    const state = {
        mode: 'SELECT', placingType: null, ghost: null, selection: null,
        wireStart: null, wireColor: 0xf44336, rotation: 0,
        isSimulating: false
    };

    const sceneObjects = { components: [], wires: [], pins: [] };

    // --- SCOPE DATA ---
    const scopeData = new Array(100).fill(0);

    // --- THREE.JS SCENE ---
    const container = document.getElementById('canvas-container');
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x151515);
    scene.fog = new THREE.Fog(0x151515, 20, 80);

    const camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
    camera.position.set(8, 12, 8);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    container.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true; controls.maxPolarAngle = Math.PI/2 - 0.1;

    // Lights
    const ambLight = new THREE.AmbientLight(0xffffff, 0.6); scene.add(ambLight);
    const dirLight = new THREE.DirectionalLight(0xffffff, 1);
    dirLight.position.set(15, 25, 10); dirLight.castShadow = true;
    dirLight.shadow.mapSize.width = 2048; dirLight.shadow.mapSize.height = 2048;
    scene.add(dirLight);

    // Grid & Plane
    scene.add(new THREE.GridHelper(config.gridSize, config.gridSize, 0x444444, 0x222222));
    const rayPlane = new THREE.Mesh(new THREE.PlaneGeometry(200, 200), new THREE.MeshBasicMaterial({visible:false}));
    rayPlane.rotation.x = -Math.PI/2; scene.add(rayPlane);

    // --- COMPONENT CLASS ---
    class LabComponent {
        constructor(type, name, id = null) {
            this.type = type;
            this.name = name;
            this.id = id || crypto.randomUUID();
            this.group = new THREE.Group();
            this.pins = [];
            this.rotationIndex = 0;
            this.internalState = { value: 0 }; 
            this.buildVisuals();
        }

        buildVisuals() {
            let color = 0x888, w=1, h=0.2, d=1, pinsDef = [];
            
            switch(this.type) {
                case 'uno': color=0x0088aa; w=3; d=2.1; 
                    pinsDef=[{x:1.3, z:-0.9, t:'5V'},{x:1.1, z:-0.9, t:'GND'},{x:-1.3, z:0.9, t:'13'},{x:0.1, z:0.9, t:'A0'}]; break;
                case 'mega': color=0x006688; w=4.5; d=2.1; 
                    pinsDef=[{x:2, z:-0.9, t:'5V'},{x:1.8, z:-0.9, t:'GND'}]; break;
                case 'esp32': color=0x111111; w=1.2; d=2; 
                    pinsDef=[{x:0.4, z:-0.8, t:'3V3'},{x:0.4, z:0.8, t:'GND'}]; break;
                case 'breadboard': color=0xffffff; w=5; d=3; 
                    pinsDef=[{x:-2,z:-1.3,t:'+'},{x:2,z:-1.3,t:'-'}]; break;
                case 'led': color=0x333; w=0.5; d=0.5; h=0.1; this.addLED(); 
                    pinsDef=[{x:-0.1, z:0, t:'A'}, {x:0.1, z:0, t:'C'}]; break;
                case 'potentiometer': color=0x333; w=0.8; d=0.8; h=0.4; this.addPot();
                    pinsDef=[{x:-0.3, z:0.3, t:'GND'}, {x:0, z:0.3, t:'SIG'}, {x:0.3, z:0.3, t:'VCC'}]; break;
                case 'resistor': w=0.8; d=0.2; h=0.2; this.addResistor(); 
                    pinsDef=[{x:-0.4,z:0,t:'1'},{x:0.4,z:0,t:'2'}]; break;
                case 'pushbutton': w=0.6; d=0.6; h=0.3; this.addButton(); 
                    pinsDef=[{x:-0.3,z:0,t:'1'},{x:0.3,z:0,t:'2'}]; break;
                case 'servo': w=1; d=0.5; h=0.5; this.addServo(); 
                    pinsDef=[{x:-0.3, z:0.3, t:'GND'}, {x:0, z:0.3, t:'VCC'}, {x:0.3, z:0.3, t:'SIG'}]; break;
            }

            if(!['led','potentiometer','resistor','pushbutton','servo'].includes(this.type)) {
                const mesh = new THREE.Mesh(new THREE.BoxGeometry(w,h,d), new THREE.MeshStandardMaterial({color:color}));
                mesh.castShadow=true; mesh.receiveShadow=true; mesh.userData={parent:this}; this.group.add(mesh); this.mesh=mesh;
            }
            pinsDef.forEach((p,i) => this.addPin(p.x, h/2+0.05, p.z, p.t, i));
        }

        // --- Visual Builders ---
        addPin(x,y,z,t,i) {
            const c = (t.includes('5V')||t.includes('VCC'))?0xff0000:(t.includes('GND')?0x000000:0xdddd00);
            const p = new THREE.Mesh(new THREE.BoxGeometry(0.12,0.12,0.12), new THREE.MeshStandardMaterial({color:c}));
            p.position.set(x,y,z); p.userData={isPin:true, componentId:this.id, pinName:t, pinIndex:i};
            this.group.add(p); this.pins.push(p); sceneObjects.pins.push(p);
        }
        addLED() {
            this.bulbMat = new THREE.MeshStandardMaterial({color:0xff0000, transparent:true, opacity:0.8});
            const b = new THREE.Mesh(new THREE.SphereGeometry(0.2), this.bulbMat); b.position.y=0.3;
            const legs = new THREE.Group(); 
            const l1 = new THREE.Mesh(new THREE.CylinderGeometry(0.02,0.02,0.3), new THREE.MeshStandardMaterial({color:0xaaa})); l1.position.set(-0.1,0.15,0);
            const l2 = l1.clone(); l2.position.set(0.1,0.15,0);
            legs.add(l1); legs.add(l2); this.group.add(legs); this.group.add(b);
            const box = new THREE.Mesh(new THREE.BoxGeometry(0.5,0.6,0.5), new THREE.MeshBasicMaterial({visible:false}));
            box.position.y=0.3; box.userData={parent:this}; this.group.add(box); this.mesh=box;
        }
        addPot() {
            const base = new THREE.Mesh(new THREE.CylinderGeometry(0.4,0.4,0.2,16), new THREE.MeshStandardMaterial({color:0x444}));
            this.knob = new THREE.Mesh(new THREE.CylinderGeometry(0.2,0.2,0.3,16), new THREE.MeshStandardMaterial({color:0x111}));
            this.knob.position.y=0.25; 
            // Indicator line
            const ind = new THREE.Mesh(new THREE.BoxGeometry(0.05,0.02,0.3), new THREE.MeshBasicMaterial({color:0xffffff}));
            ind.position.y=0.16; ind.position.z=0.05; this.knob.add(ind);
            base.add(this.knob); base.userData={parent:this}; this.group.add(base); this.mesh=base;
        }
        addResistor() {
            const b = new THREE.Mesh(new THREE.CylinderGeometry(0.08,0.08,0.8).rotateZ(Math.PI/2), new THREE.MeshStandardMaterial({color:0xe6c99c}));
            b.position.y=0.1; b.userData={parent:this}; this.group.add(b); this.mesh=b;
        }
        addButton() {
            const b = new THREE.Mesh(new THREE.BoxGeometry(0.6,0.2,0.6), new THREE.MeshStandardMaterial({color:0x333}));
            this.cap = new THREE.Mesh(new THREE.CylinderGeometry(0.15,0.15,0.1), new THREE.MeshStandardMaterial({color:0x111}));
            this.cap.position.y=0.15; b.add(this.cap); b.userData={parent:this}; this.group.add(b); this.mesh=b;
        }
        addServo() {
            const b = new THREE.Mesh(new THREE.BoxGeometry(0.8,0.4,1.2), new THREE.MeshStandardMaterial({color:0x111}));
            b.position.y=0.2; this.arm = new THREE.Mesh(new THREE.BoxGeometry(0.2,0.1,1.6), new THREE.MeshStandardMaterial({color:0xffffff}));
            this.arm.position.y=0.3; b.add(this.arm); b.userData={parent:this}; this.group.add(b); this.mesh=b;
        }

        setRotation(s) { this.rotationIndex = s%4; this.group.rotation.y = -this.rotationIndex*(Math.PI/2); }
        setPosition(p) { this.group.position.copy(p); }
        highlight(b) { if(this.mesh.material.emissive) this.mesh.material.emissive.setHex(b?0x444444:0x000000); }

        // --- SIMULATION LOGIC ---
        updateVisuals(v) {
            if(this.type==='led') { this.bulbMat.emissive.setHex(v>2?0xff0000:0); this.bulbMat.emissiveIntensity=v>2?2:0; }
            if(this.type==='servo' && v>2) this.arm.rotation.y+=0.1;
            if(this.type==='potentiometer') {
                 // Rotate visual knob based on internal value (0-100)
                 this.knob.rotation.y = (this.internalState.value/100) * (Math.PI*1.5) - (Math.PI*0.75);
            }
        }
        interact() {
            if(this.type==='pushbutton') { 
                this.cap.position.y=0.1; setTimeout(()=>this.cap.position.y=0.15, 150); return true; 
            }
            return false;
        }
    }

    // --- INTERACTION ---
    const raycaster = new THREE.Raycaster(); const mouse = new THREE.Vector2();
    function getIntersect(e, objs) {
        const r = container.getBoundingClientRect();
        mouse.x=((e.clientX-r.left)/r.width)*2-1; mouse.y=-((e.clientY-r.top)/r.height)*2+1;
        raycaster.setFromCamera(mouse, camera); return raycaster.intersectObjects(objs)[0];
    }

    container.addEventListener('mousedown', (e) => {
        if(e.button!==0) return;
        if(state.mode==='PLACING') {
            const hit = getIntersect(e, [rayPlane]);
            if(hit) {
                const x=Math.round(hit.point.x/config.snap)*config.snap, z=Math.round(hit.point.z/config.snap)*config.snap;
                const c = new LabComponent(state.placingType, `${state.placingType.toUpperCase()}_${sceneObjects.components.length+1}`);
                c.setPosition(new THREE.Vector3(x,0,z)); c.setRotation(state.rotation);
                scene.add(c.group); sceneObjects.components.push(c);
                updateBOM();
            }
            return;
        }
        let hit = getIntersect(e, sceneObjects.pins);
        if(hit) { handlePin(hit.object); return; }
        hit = getIntersect(e, sceneObjects.components.map(c=>c.mesh));
        if(hit) {
            const c = hit.object.userData.parent;
            if(!state.isSimulating || !c.interact()) selectComp(c);
        } else selectComp(null);
    });

    container.addEventListener('mousemove', (e) => {
        const hit = getIntersect(e, [rayPlane]);
        if(hit && state.mode==='PLACING' && state.ghost) {
            state.ghost.position.set(Math.round(hit.point.x/config.snap)*config.snap, 0, Math.round(hit.point.z/config.snap)*config.snap);
        }
    });

    function handlePin(p) {
        if(state.mode!=='WIRE') return;
        if(!state.wireStart) { state.wireStart=p; p.material.emissive.setHex(0xffff00); }
        else { 
            if(state.wireStart!==p) createWire(state.wireStart, p);
            state.wireStart.material.emissive.setHex(0); state.wireStart=null; 
        }
    }

    function createWire(p1, p2) {
        const v1=new THREE.Vector3(), v2=new THREE.Vector3(); p1.getWorldPosition(v1); p2.getWorldPosition(v2);
        const d=v1.distanceTo(v2), m=v1.clone().add(v2).multiplyScalar(0.5); m.y+=Math.max(1,d*0.4);
        const c = new THREE.QuadraticBezierCurve3(v1,m,v2);
        const mesh = new THREE.Mesh(new THREE.TubeGeometry(c,20,0.03,6,false), new THREE.MeshStandardMaterial({color:state.wireColor}));
        scene.add(mesh);
        sceneObjects.wires.push({mesh, startPin:p1, endPin:p2, startCompId:p1.userData.componentId, startPinName:p1.userData.pinName, endCompId:p2.userData.componentId, endPinName:p2.userData.pinName, color:state.wireColor});
    }

    function selectComp(c) {
        if(state.selection) state.selection.highlight(false);
        state.selection=c;
        const p=document.getElementById('prop-fields'), e=document.getElementById('prop-empty');
        if(c) {
            c.highlight(true); p.style.display='block'; e.style.display='none';
            document.getElementById('prop-name').value=c.name;
            document.getElementById('prop-type').innerText=c.type.toUpperCase();
            // Show Slider for Potentiometer
            const slider = document.getElementById('prop-extra');
            if(c.type === 'potentiometer') {
                slider.style.display = 'block';
                document.getElementById('prop-slider').value = c.internalState.value || 0;
            } else {
                slider.style.display = 'none';
            }
        } else { p.style.display='none'; e.style.display='block'; }
    }

    // --- UI HELPERS ---
    window.setMode = (m) => {
        state.mode=m; if(state.ghost){scene.remove(state.ghost);state.ghost=null;}
        document.querySelectorAll('.tool-btn').forEach(b=>b.classList.remove('active'));
        if(m==='SELECT') document.getElementById('tool-select').classList.add('active');
        if(m==='WIRE') document.getElementById('tool-wire').classList.add('active');
        document.getElementById('controls-hint').classList.toggle('visible', m==='PLACING');
    };
    window.startPlacement = (t) => {
        window.setMode('PLACING'); state.placingType=t; state.rotation=0;
        const c = new LabComponent(t,'Ghost'); state.ghost=c.group;
        state.ghost.traverse(o=>{if(o.isMesh){o.material=o.material.clone();o.material.transparent=true;o.material.opacity=0.5;}});
        scene.add(state.ghost);
    };
    window.deleteSelected = () => {
        if(!state.selection) return;
        const c=state.selection; scene.remove(c.group);
        const wRem=sceneObjects.wires.filter(w=>w.startCompId===c.id||w.endCompId===c.id);
        wRem.forEach(w=>{scene.remove(w.mesh); sceneObjects.wires.splice(sceneObjects.wires.indexOf(w),1);});
        c.pins.forEach(p=>sceneObjects.pins.splice(sceneObjects.pins.indexOf(p),1));
        sceneObjects.components.splice(sceneObjects.components.indexOf(c),1);
        state.selection=null; selectComp(null); updateBOM();
    };
    window.setWireColor=(h,e)=>{state.wireColor=h;document.querySelectorAll('.color-swatch').forEach(d=>d.classList.remove('active'));e.classList.add('active');};
    window.toggleCode=()=>document.getElementById('code-editor').classList.toggle('open');
    window.toggleCat=(e)=>{const c=e.nextElementSibling;c.style.display=c.style.display==='none'?'grid':'none';};
    window.toggleHelp=()=>{const m=document.getElementById('modal-overlay');m.style.display=m.style.display==='flex'?'none':'flex';};
    
    // --- PROFESSIONAL FEATURES ---
    window.switchTab = (tabId) => {
        document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(`tab-${tabId}`).classList.add('active');
    };

    window.updatePot = (val) => {
        if(state.selection && state.selection.type === 'potentiometer') {
            state.selection.internalState.value = parseInt(val);
            state.selection.updateVisuals();
        }
    };

    window.updateBOM = () => {
        const list = document.getElementById('bom-list');
        const counts = {};
        sceneObjects.components.forEach(c => counts[c.type] = (counts[c.type] || 0) + 1);
        list.innerHTML = Object.entries(counts).map(([type, count]) => 
            `<li class="bom-item"><span>${type.toUpperCase()}</span> <span>x${count}</span></li>`
        ).join('');
    };

    window.exportBOM = () => {
        let csv = "Part Type, Quantity\n";
        const counts = {};
        sceneObjects.components.forEach(c => counts[c.type] = (counts[c.type] || 0) + 1);
        Object.entries(counts).forEach(([t, c]) => csv += `${t.toUpperCase()},${c}\n`);
        const b = new Blob([csv], {type:'text/csv'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'bom.csv'; a.click();
    };

    function drawScope() {
        const cvs = document.getElementById('scope-canvas');
        const ctx = cvs.getContext('2d');
        ctx.fillStyle = '#000'; ctx.fillRect(0,0,300,200);
        
        // Grid
        ctx.strokeStyle = '#333'; ctx.beginPath();
        for(let i=0; i<300; i+=30) { ctx.moveTo(i,0); ctx.lineTo(i,200); }
        for(let i=0; i<200; i+=30) { ctx.moveTo(0,i); ctx.lineTo(300,i); }
        ctx.stroke();

        // Signal
        ctx.strokeStyle = '#0f0'; ctx.lineWidth = 2; ctx.beginPath();
        scopeData.forEach((val, i) => {
            const x = (i / scopeData.length) * 300;
            const y = 200 - (val / 1024) * 200; // Map 0-1024 to height
            if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        });
        ctx.stroke();
    }

    // --- SIMULATION ENGINE (PRO) ---
    const serialOutput = document.getElementById('serial-output');

    window.toggleSim = async () => {
        state.isSimulating = !state.isSimulating;
        const b1=document.getElementById('btn-run'), b2=document.getElementById('btn-stop');
        if(state.isSimulating) {
            b1.style.display='none'; b2.style.display='flex';
            serialOutput.innerText = "> System Boot...\n";
            startRuntime();
        } else {
            b1.style.display='flex'; b2.style.display='none';
            sceneObjects.components.forEach(c => c.updateVisuals(0));
        }
    };

    async function startRuntime() {
        const jsCode = document.getElementById('editor-text').value
            .replace(/int /g,'var ').replace(/void setup/g,'async function setup')
            .replace(/void loop/g,'async function loop').replace(/delay\(/g,'await delay(');

        const pinState = {};
        const OUTPUT=1, INPUT=0, HIGH=1, LOW=0;

        const pinMode = () => {};
        const digitalWrite = (p, v) => { pinState[p] = v; propagateCircuit(pinState); };
        const analogRead = (p) => {
            // Find component connected to pin A0 (Simple Proximity Logic for demo)
            // Ideally use connectivity graph. Here we check if a Potentiometer exists.
            const pot = sceneObjects.components.find(c => c.type === 'potentiometer');
            if(pot) return Math.floor((pot.internalState.value / 100) * 1024);
            return 0; // Floating
        };
        const delay = (ms) => new Promise(r => setTimeout(r, ms));
        const Serial = {
            begin:()=>{}, println:(m)=>{serialOutput.innerText+=m+"\n"; serialOutput.scrollTop=serialOutput.scrollHeight;},
            print:(m)=>{serialOutput.innerText+=m;}
        };
        const Scope = {
            plot: (val) => {
                scopeData.shift(); scopeData.push(val); drawScope();
            }
        };

        try {
            await eval(`(async()=>{
                ${jsCode}
                if(typeof setup === 'function') await setup();
                while(state.isSimulating) {
                    if(typeof loop === 'function') await loop();
                    await delay(50);
                }
            })()`);
        } catch(e) { serialOutput.innerText += `ERR: ${e.message}\n`; }
    }

    function propagateCircuit(pinState) {
        const activePins = [];
        const ardu = sceneObjects.components.find(c=>['uno','mega'].includes(c.type));
        if(!ardu) return;
        
        ardu.pins.forEach(p => { if(p.userData.pinName.match(/5V|3V3/)) activePins.push(p); });
        for(const [p,v] of Object.entries(pinState)) {
             if(v===1) { const pin = ardu.pins.find(pp=>pp.userData.pinName==p); if(pin) activePins.push(pin); }
        }
        
        const gndPins = ardu.pins.filter(p => p.userData.pinName.includes('GND'));

        sceneObjects.components.forEach(c => {
             if(c.type === 'led') {
                 const a = c.pins[0], k = c.pins[1];
                 if(isConnected(a, activePins) && isConnected(k, gndPins)) c.updateVisuals(5);
                 else c.updateVisuals(0);
             }
        });
    }

    function isConnected(start, targets) {
        if(!start || targets.length===0) return false;
        let q=[start], v=new Set();
        while(q.length>0) {
            let cur = q.shift(); if(targets.includes(cur)) return true;
            v.add(cur);
            sceneObjects.wires.forEach(w=>{
                let n=null; if(w.startPin===cur)n=w.endPin; if(w.endPin===cur)n=w.startPin;
                if(n && !v.has(n)) q.push(n);
            });
        }
        return false;
    }

    // --- LOOP & EVENTS ---
    function animate() { requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); }
    animate();
    window.addEventListener('resize', () => { camera.aspect=container.clientWidth/container.clientHeight; camera.updateProjectionMatrix(); renderer.setSize(container.clientWidth, container.clientHeight); });
    window.addEventListener('keydown', (e) => {
        if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA') return;
        if(e.key==='Escape') window.setMode('SELECT');
        if(e.key==='Delete') window.deleteSelected();
        if(e.key.toLowerCase()==='r' && state.mode==='PLACING') { state.rotation=(state.rotation+1)%4; state.ghost.rotation.y=-state.rotation*(Math.PI/2); }
    });

    // Init BOM
    updateBOM();
</script>
</body>
</html>
